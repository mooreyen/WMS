<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>領入料</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        .navbar {
            margin-bottom: 20px;
            background-color: #e9ecef;
            padding: 10px 20px;
            border-radius: 5px;
            display: flex;
            align-items: center;
        }
        .navbar a {
            margin-right: 15px;
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
            font-size: 18px;
        }
        .navbar a:hover {
            text-decoration: underline;
        }
        h1, h2 {
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.05);
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            color: #333;
        }
        input[type="date"], input[type="number"], select, input[type="text"] {
            width: calc(100% - 16px);
            padding: 8px;
            margin: 5px 0;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #218838;
        }
        .log-table-container {
            max-height: 400px; /* 設定最大高度 */
            overflow-y: auto; /* 超出高度時顯示滾動條 */
            border: 1px solid #ddd; /* 給滾動區域加個邊框 */
            background-color: white;
        }
        .log-table-container table {
            margin-top: 0; /* 清除表格的頂部外邊距 */
        }
    </style>
</head>
<body>

    <div class="navbar">
        <a href="overview.html">總覽</a>
        <a href="material_form.html">領入料</a>
        <a href="#" onclick="logout()">登出</a>
        <span id="currentUserDisplay" style="margin-left: 20px; font-weight: normal; color: #555;"></span>
    </div>

    <h1>物料領入記錄</h1>

    <table>
        <thead>
            <tr>
                <th>日期</th>
                <th>領入料類型</th>
                <th>料號</th>
                <th>品名</th>
                <th>型號</th>
                <th>規格</th>
                <th>單位</th>
                <th>數量</th>
                <th>填表人</th>
                <th>專案</th>
                <th>備註</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><input type="date" id="inputDate"></td>
                <td>
                    <select id="inputReceiveType">
                        <option value="領料">領料</option>
                        <option value="入料">入料</option>
                        <option value="借料">借料</option>
                        <option value="歸還">歸還</option>
                    </select>
                </td>
                <td>
                    <select id="inputPartNumber" onchange="populateMaterialDetails()">
                        <option value="">請選擇料號</option>
                        </select>
                </td>
                <td><input type="text" id="inputProductName" readonly></td>
                <td><input type="text" id="inputModel" readonly></td>
                <td><input type="text" id="inputSpecification" readonly></td>
                <td><input type="text" id="inputUnit" readonly></td>
                <td><input type="number" id="inputQuantity" min="1"></td>
                <td><input type="text" id="inputFiller" readonly></td>
                <td><input type="text" id="inputProject"></td>
                <td><input type="text" id="inputRemarks"></td>
            </tr>
        </tbody>
    </table>
    <button onclick="addMaterialLog()">新增記錄</button>

    <h2>物料記錄日誌 (最近50筆)</h2>
    <div class="log-table-container">
        <table id="materialLogTable">
            <thead>
                <tr>
                    <th>日期</th>
                    <th>類型</th>
                    <th>料號</th>
                    <th>品名</th>
                    <th>數量</th>
                    <th>填表人</th>
                    <th>專案</th>
                    <th>備註</th>
                    <th>記錄時間</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <script>
        // 將 API_BASE_URL 設定為您 Firebase Cloud Functions 的基礎 URL
        const API_BASE_URL = 'https://asia-east1-accvisinno.cloudfunctions.net'; // <-- 已更新為您的專案 URL
        const LOG_DISPLAY_LIMIT = 50; // 顯示日誌的筆數限制

        const inputDate = document.getElementById('inputDate');
        const inputPartNumber = document.getElementById('inputPartNumber');
        const inputProductName = document.getElementById('inputProductName');
        const inputModel = document.getElementById('inputModel');
        const inputSpecification = document.getElementById('inputSpecification');
        const inputUnit = document.getElementById('inputUnit');
        const inputFiller = document.getElementById('inputFiller');
        const materialLogTableBody = document.getElementById('materialLogTable').getElementsByTagName('tbody')[0];

        let overviewMaterialsData = []; // 用於儲存從後端獲取的物料總覽資料

        window.onload = async function() {
            const loggedInUser = sessionStorage.getItem('loggedInUser');
            const authToken = sessionStorage.getItem('authToken');
            const currentUserDisplay = document.getElementById('currentUserDisplay');

            if (loggedInUser && authToken) {
                if (currentUserDisplay) {
                    currentUserDisplay.textContent = `您好，${loggedInUser}！`;
                }
                inputFiller.value = loggedInUser; // 自動填入填表人

                // 自動設定今天的日期
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months start at 0!
                const dd = String(today.getDate()).padStart(2, '0');
                inputDate.value = `${yyyy}-${mm}-${dd}`;

                await loadOverviewMaterialsAndPopulatePartNumbers(); // 載入物料總覽並填充料號下拉選單
                await fetchAndDisplayMaterialLogs(); // 載入並顯示物料日誌
            } else {
                sessionStorage.clear(); // 清除無效的登入資訊
                window.location.href = 'login.html'; // 重導回登入頁
            }
        };

        // 載入物料總覽資料並填充料號下拉選單
        async function loadOverviewMaterialsAndPopulatePartNumbers() {
            try {
                // 從 Cloud Function 獲取物料總覽資料
                const response = await fetch(`${API_BASE_URL}/getOverviewMaterials`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                overviewMaterialsData = await response.json(); // 儲存獲取的資料

                inputPartNumber.innerHTML = '<option value="">請選擇料號</option>'; // 清空並添加預設選項
                overviewMaterialsData.forEach(material => {
                    const option = document.createElement('option');
                    option.value = material.partNumber;
                    option.textContent = `${material.partNumber} - ${material.productName}`;
                    inputPartNumber.appendChild(option);
                });
            } catch (error) {
                console.error('載入物料總覽失敗:', error);
                alert('無法載入物料總覽資料，請檢查後端服務是否運行。');
            }
        }

        // 根據選擇的料號自動填充品名、型號、規格、單位
        function populateMaterialDetails() {
            const selectedPartNumber = inputPartNumber.value;
            const selectedMaterial = overviewMaterialsData.find(material => material.partNumber === selectedPartNumber);

            if (selectedMaterial) {
                inputProductName.value = selectedMaterial.productName || '';
                inputModel.value = selectedMaterial.model || '';
                inputSpecification.value = selectedMaterial.specification || '';
                inputUnit.value = selectedMaterial.unit || '';
            } else {
                // 如果沒有選擇或找不到對應的料號，則清空相關欄位
                inputProductName.value = '';
                inputModel.value = '';
                inputSpecification.value = '';
                inputUnit.value = '';
            }
        }

        // 新增領入料記錄
        async function addMaterialLog() {
            const date = inputDate.value;
            const receiveType = document.getElementById('inputReceiveType').value;
            const partNumber = inputPartNumber.value;
            const productName = inputProductName.value; // 從自動填充的欄位獲取
            const model = inputModel.value;
            const specification = inputSpecification.value;
            const unit = inputUnit.value;
            const quantity = document.getElementById('inputQuantity').value;
            const filler = inputFiller.value;
            const project = document.getElementById('inputProject').value;
            const remarks = document.getElementById('inputRemarks').value;

            if (!date || !receiveType || !partNumber || !quantity || !filler) {
                alert('請填寫所有必填欄位 (日期、領入料類型、料號、數量、填表人)！');
                return;
            }
            if (isNaN(parseInt(quantity)) || parseInt(quantity) <= 0) {
                alert('數量必須是有效的正數字！');
                return;
            }

            const logData = {
                date,
                receiveType,
                partNumber,
                productName,
                model,
                specification,
                unit,
                quantity: parseInt(quantity),
                filler,
                project,
                remarks
            };

            try {
                // 向 Cloud Function 發送新增記錄的請求
                const response = await fetch(`${API_BASE_URL}/addMaterialLog`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(logData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert('記錄新增成功，庫存已更新！');
                    // 成功後重新載入日誌和物料總覽，以便更新數量和下拉選單
                    await loadOverviewMaterialsAndPopulatePartNumbers();
                    await fetchAndDisplayMaterialLogs();
                    // 清空輸入欄位 (除填表人和日期)
                    inputPartNumber.value = '';
                    populateMaterialDetails(); // 清空相關顯示欄位
                    document.getElementById('inputQuantity').value = '';
                    document.getElementById('inputProject').value = '';
                    document.getElementById('inputRemarks').value = '';
                    document.getElementById('inputReceiveType').value = '領料'; // 重設為預設值
                } else {
                    alert('新增記錄失敗: ' + (result.message || '未知錯誤'));
                }
            } catch (error) {
                console.error('新增記錄請求失敗:', error);
                alert('新增記錄服務暫時無法使用。');
            }
        }

        // 獲取並顯示物料日誌
        async function fetchAndDisplayMaterialLogs() {
            try {
                // 從 Cloud Function 獲取物料日誌
                const response = await fetch(`${API_BASE_URL}/getMaterialLogs?limit=${LOG_DISPLAY_LIMIT}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const logs = await response.json();
                displayMaterialLogs(logs);
            } catch (error) {
                console.error('獲取物料日誌失敗:', error);
                alert('無法載入物料日誌，請檢查後端服務是否運行。');
            }
        }

        // 顯示物料日誌到表格中
        function displayMaterialLogs(logs) {
            materialLogTableBody.innerHTML = ''; // 清空現有內容

            if (logs && logs.length > 0) {
                logs.forEach(log => {
                    const newRow = materialLogTableBody.insertRow();
                    newRow.insertCell(0).textContent = log.date;
                    newRow.insertCell(1).textContent = log.receiveType;
                    newRow.insertCell(2).textContent = log.partNumber;
                    newRow.insertCell(3).textContent = log.productName;
                    newRow.insertCell(4).textContent = log.quantity;
                    newRow.insertCell(5).textContent = log.filler;
                    newRow.insertCell(6).textContent = log.project;
                    newRow.insertCell(7).textContent = log.remarks;

                    // 格式化時間戳記
                    const timestampCell = newRow.insertCell(8);
                    if (log.timestamp) {
                        const date = new Date(log.timestamp);
                        timestampCell.textContent = date.toLocaleString('zh-TW', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: false // 24小時制
                        });
                    } else {
                        timestampCell.textContent = '';
                    }
                });
            } else {
                const newRow = materialLogTableBody.insertRow();
                const cell = newRow.insertCell(0);
                cell.colSpan = 9;
                cell.textContent = '目前沒有物料記錄日誌。';
                cell.style.textAlign = 'center';
                cell.style.color = '#888';
            }
        }

        // 登出功能
        function logout() {
            const confirmLogout = confirm("您確定要登出嗎？");
            if (confirmLogout) {
                sessionStorage.clear(); // 清除所有 session 儲存的資訊
                window.location.href = 'login.html'; // 重導回登入頁
            }
        }
    </script>

</body>
</html>